{% extends "base.html" %}

{% block title %}{{ patient.name }} - {{ session.clinic_name }}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üë§ {{ patient.name }} ({{ patient.patient_id }})</h2>
        <div>
            <a href="{{ url_for('new_prescription', patient_id=patient.id) }}" class="btn">üíä New Prescription</a>
            <a href="{{ url_for('patients') }}" class="btn btn-secondary">‚Üê Back</a>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <div>
            <strong>Age:</strong> {{ patient.age }} years<br>
            <strong>Gender:</strong> {{ patient.gender }}<br>
            <strong>Blood Group:</strong> {{ patient.blood_group or 'Not specified' }}
        </div>
        <div>
            <strong>Phone:</strong> {{ patient.phone }}<br>
            <strong>Email:</strong> {{ patient.email or '-' }}<br>
            <strong>Registered:</strong> {{ patient.registration_date.strftime('%d-%b-%Y') }}
        </div>
        <div>
            <strong>Last Visit:</strong> {{ patient.last_visit.strftime('%d-%b-%Y') if patient.last_visit else 'Never' }}<br>
            <strong>Total Visits:</strong> {{ consultations|length }}
        </div>
    </div>
    
    {% if patient.allergies %}
    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
        <strong>‚ö†Ô∏è Allergies:</strong> {{ patient.allergies }}
    </div>
    {% endif %}
    
    {% if patient.chronic_conditions %}
    <div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 5px;">
        <strong>üè• Chronic Conditions:</strong> {{ patient.chronic_conditions }}
    </div>
    {% endif %}
</div>

{% if upcoming_appointments %}
<div class="card">
    <h2>üìÖ Upcoming Appointments</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Reason</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for appt in upcoming_appointments %}
            <tr>
                <td>{{ appt.appointment_date.strftime('%d-%b-%Y') }}</td>
                <td>{{ appt.appointment_time }}</td>
                <td>{{ appt.reason or '-' }}</td>
                <td><span class="badge {{ appt.status }}">{{ appt.status }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Prescriptions Section -->
<div class="card">
    <h2>üíä Prescriptions</h2>
    {% if patient.prescriptions %}
        <table class="table">
            <thead>
                <tr>
                    <th>Prescription #</th>
                    <th>Date</th>
                    <th>Diagnosis</th>
                    <th>Medicines</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for prescription in patient.prescriptions|sort(attribute='created_at', reverse=True) %}
                <tr>
                    <td><strong>{{ prescription.prescription_number }}</strong></td>
                    <td>{{ prescription.created_at.strftime('%d-%b-%Y %H:%M') }}</td>
                    <td>{{ prescription.diagnosis or '-' }}</td>
                    <td>{{ prescription.medicines|length }} medicine(s)</td>
                    <td>
                        <a href="{{ url_for('view_prescription', prescription_id=prescription.id) }}" 
                           class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">View</a>
                        <a href="{{ url_for('edit_prescription', prescription_id=prescription.id) }}" 
                           class="btn" style="padding: 5px 10px; font-size: 12px; background: #28a745;">Edit</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center; padding: 40px; color: #999;">
            No prescriptions yet.
            <a href="{{ url_for('new_prescription', patient_id=patient.id) }}" class="btn" style="margin-top: 10px;">Create First Prescription</a>
        </p>
    {% endif %}
</div>

<div class="card">
    <h2>üìã Consultation History</h2>
    {% if consultations %}
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Diagnosis</th>
                    <th>Vitals (BP/Pulse/Temp)</th>
                    <th>Fee</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for consult in consultations %}
                <tr>
                    <td>{{ consult.consultation_date.strftime('%d-%b-%Y %H:%M') }}</td>
                    <td>{{ consult.diagnosis or '-' }}</td>
                    <td>
                        {% if consult.bp_systolic %}{{ consult.bp_systolic }}/{{ consult.bp_diastolic }}{% else %}-{% endif %} | 
                        {{ consult.pulse or '-' }} | 
                        {{ consult.temperature or '-' }}¬∞F
                    </td>
                    <td>‚Çπ{{ "%.0f"|format(consult.total_amount) }}</td>
                    <td>
                        <a href="{{ url_for('view_consultation', consultation_id=consult.id) }}" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center; padding: 40px; color: #999;">No consultation history yet.</p>
    {% endif %}
</div>
{% endblock %}


